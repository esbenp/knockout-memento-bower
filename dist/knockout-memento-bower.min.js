!function(t,e){"function"==typeof define&&define.amd?define(["knockout"],e):"object"==typeof exports?module.exports=e(require("knockout")):t.ko=e(t.ko)}(this,function(t){return t.msf.ErrorHandler=function(){var t=function(t){var e=new Error;throw e.message="ko.Memento Error: "+t,e};return{throwError:t}}(),t.extenders.registerToMS=function(e,n){n=n||{};var r=n.stack||t.msf.getDefaultStack(),i=t.computed({read:function(){return e()},write:function(t){i.dontReg||i.registerCurrentValue(),e(t)}});return i.dontReg=!1,i.stopRegistering=function(){i.dontReg=!0},i.resumeRegistering=function(){i.dontReg=!1},i.registerCurrentValue=function(){i.registerAValue(e())},i.registerAValue=function(t){r.stackChange(n.context,i,t)},i.valueHasMutated=function(){i.notifySubscribers(e)},i},t.extenders.registerArrayToMS=function(e,n){n=n||{};var r=n.stack||t.msf.getDefaultStack();return e.subscribe(function(t){e.dontReg||e.registerAValue(t)},this,"beforeChange"),e.dontReg=!1,e.stopRegistering=function(){result.dontReg=!0},e.resumeRegistering=function(){result.dontReg=!1},e.registerCurrentValue=function(){result.registerAValue(e())},e.registerAValue=function(t){var i=t.slice(0);r.stackChange(n.context,e,i)},e},t.registerdObservable=function(e,n){var r=t.observable(e);n=n||{};var i=n.stack||t.msf.getDefaultStack(),o=t.computed({read:function(){return r()},write:function(t){o.dontReg||o.registerCurrentValue(),r(t)}});return o.stopRegistering=function(){o.dontReg=!0},o.resumeRegistering=function(){o.dontReg=!1},o.registerCurrentValue=function(){o.registerAValue(r())},o.registerAValue=function(t){i.stackChange(n.context,o,t)},o.valueHasMutated=function(){o.notifySubscribers(r)},o},t.msf.mStack.Memento=function(e,n,r){var i=e||function(){},o=function(t){t instanceof Array&&t.forEach(function(t){t({context:i,subject:n,value:r})})};this.trigger=function(t){return o(t),n(r),this.clearForGc()},this.duplicate=function(){return new t.msf.mStack.Memento(i,n,n())},this.clearForGc=function(){n=void 0,r=void 0,i=void 0;for(var t in this)this.hasOwnProperty(t)&&(this[t]=void 0);return!0}},t.msf.mStack=function(e){e=e||{},e={stackLimit:e.stackLimit||50,discardUndefined:e.discardUndefined||!1};var n=t.msf.ErrorHandler,r=!0,i=[],o=[],u=[],s=[],c=0,a=!1,f=t.observable(!1),g=function(t,n){t.length>e.stackLimit&&t.shift(),t.push(n.splice(0)),n.length=0,f(!0)},h=function(t,e){var n=t.pop();if(!n)return!1;var r=[];return n.forEach(function(t){r.unshift(t.duplicate()),a=!0,t.trigger(i),a=!1}.bind(this)),e.push(r.splice(0)),r.length=0,f(o.length>0),!0},d=function(){o.length=0,u.length=0};this.clearForGc=function(){i.length=0,o.length=0,u.length=0,s.length=0;for(var t in this)this.hasOwnProperty(t)&&(this[t]=void 0);return!0},this.reInit=function(){d(),s.length=0,a=!1,c=!1,f(!1)},this.isUpdating=function(){return a},this.stopListening=function(){r=!1},this.resumeListening=function(){r=!0},this.subscribeTo=function(t){if(!t instanceof Function)return n.throwError("Subscriber is not an instance of Function"),!1;i.push(t);var e={};return e.dispose=function(){var e=i.indexOf(t);i.splice(e,1)},e},this.stackChange=function(i,f,h){if(a||!r)return!1;if(!f)return n.throwError("No subject has been passed to register on"),!1;if(e.discardUndefined&&void 0===h)return!1;u.length=0;var d=new t.msf.mStack.Memento(i,f,h);return s.push(d),c>0?!0:(g(o,s),!0)},this.triggerUndo=function(){return h(o,u)},this.triggerRedo=function(){return h(u,o)},this.startSequencing=function(){c+=1},this.stopSequencing=function(){c-=1,0>c&&(c=0,n.throwError("Sequencing Mode has been stooped but but never started, ignored")),c>0||g(o,s.reverse())},this.hasUndos=function(){return o.length>0},this.hasRedos=function(){return u.length>0},this.isDirty=t.computed(function(){return f()})},t.msf=function(){var e=t.observableArray([]),n=function(){return e()},r=function(){e().forEach(function(t){t.reInit()})},i=function(){e().forEach(function(t){t.clearForGc()}),e.removeAll()},o=function(n){var r=new t.msf.mStack(n);return e.push(r),r},u=function(t){var n=e.indexOf(t);return-1==n?!1:(t.clearForGc(),e.splice(n,1),!0)},s=function(){return e().length?e()[0]:o()},c=function(){return e().length>0?e()[e().length-1]:void 0},a=t.computed(function(){return e().some(function(t){return t.isDirty()})});return{getStacks:n,killStack:u,purgeStacks:i,clearStacks:r,getDefaultStack:s,getLastStack:c,createStack:o,isDirty:a}}(),t});